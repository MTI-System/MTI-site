services:
  postgresDatabase:
    image: postgres:17
    pull_policy: always
    container_name: postgres_database_dev
    ports:
      - "5431:5432"
    networks:
      mti-dev-network:
        aliases:
          - postgres
    environment:
      POSTGRES_PASSWORD: ${DB_PASS}
      PGDATA: /var/lib/postgresql/mti-dev-data/mti-dev-pgdata
    volumes:
      - mti-dev-pgdata:/var/lib/postgresql/mti-dev-data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d postgres -h localhost -p 5432"]
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s


  frontend:
    image: mof1us/frontend_mti_dev:latest
    pull_policy: always
    container_name: site_frontend_dev
    ports:
      - "5000:3000"
    networks:
      mti-dev-network:
        aliases:
          - frontend
    environment:
      NEXT_PUBLIC_IS_ON_DEV: true
      DADATA_API: ${DADATA_API}
    healthcheck:
      test: [ "CMD-SHELL", "wget -qO- http://localhost:3000/ | grep -qi '<html'" ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 15s


  eurekaServer:
    image: mof1us/eureka-mti-service-dev:latest
    pull_policy: always
    container_name: eureka_server_dev
    ports:
      - "5001:8761"
    networks:
      mti-dev-network:
        aliases:
          - eureka
    healthcheck:
      test: [ "CMD-SHELL", "wget -qO- http://localhost:8761/actuator/health | grep -q '\"status\":\"UP\"'" ]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 10s


  gateway:
    image: mof1us/api-gateway-mti-dev:latest
    pull_policy: always
    container_name: gateway_service_dev
    ports:
      - "5002:8080"
    networks:
      mti-dev-network:
        aliases:
          - gateway
    depends_on:
      eurekaServer:
        condition: service_healthy
      postgresDatabase:
        condition: service_healthy
    environment:
      EUREKA_SERVER_PORT: 8761
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: AuthMtiDatabase
      DB_USERNAME: postgres
      DB_PASSWORD: ${DB_PASS}
      EUREKA_SERVER_HOST: eureka
      JWT_SECRET: ${JWT_SECRET}
      BACKEND_API_KEY: ${BACKEND_API_KEY}
    healthcheck:
      test: [ "CMD-SHELL", "wget -qO- http://localhost:8080/actuator/health | grep -q '\"status\":\"UP\"'" ]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 20s

  problemsService:
    image: mof1us/problems-mti-service-dev:latest
    pull_policy: always
    container_name: problems_service_dev
    environment:
      EUREKA_SERVER_PORT: 8761
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ProblemsMtiDatabase
      DB_USERNAME: postgres
      DB_PASSWORD: ${DB_PASS}
      EUREKA_SERVER_HOST: eureka
      API_GATEWAY: http://gateway:8080
    depends_on:
      eurekaServer:
        condition: service_healthy
      postgresDatabase:
        condition: service_healthy
    networks:
      - mti-dev-network
    healthcheck:
      test: [ "CMD-SHELL", "wget -qO- http://localhost:8080/actuator/health | grep -q '\"status\":\"UP\"'" ]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 20s


  materialsService:
    image: mof1us/material-service-mti-dev:latest
    pull_policy: always
    environment:
      EUREKA_SERVER_PORT: 8761
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: MaterialsMtiDatabase
      DB_USERNAME: postgres
      DB_PASSWORD: ${DB_PASS}
      EUREKA_SERVER_HOST: eureka
      API_GATEWAY: http://gateway:8080
    depends_on:
      eurekaServer:
        condition: service_healthy
      postgresDatabase:
        condition: service_healthy
    networks:
      - mti-dev-network
    healthcheck:
      test: [ "CMD-SHELL", "wget -qO- http://localhost:8080/actuator/health | grep -q '\"status\":\"UP\"'" ]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 20s


  filesService:
    image: mof1us/files-service-mti:latest
    pull_policy: always
    environment:
      FILE_DIR: /files
      BACKEND_API_KEY: ${BACKEND_API_KEY}
    volumes:
      - /opt/mti/files:/files:rw
    networks:
      - mti-dev-network


  notificationsService:
    image: mof1us/notifications-mti-service-dev:latest
    pull_policy: always
    environment:
      EUREKA_SERVER_PORT: 8761
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: NotificationsMtiDatabaseDev
      DB_USERNAME: postgres
      DB_PASSWORD: ${DB_PASS}
      EUREKA_SERVER_HOST: eureka
      API_GATEWAY: http://gateway:8080
      BACKEND_API_KEY: ${BACKEND_API_KEY}
    depends_on:
      eurekaServer:
        condition: service_healthy
      postgresDatabase:
        condition: service_healthy
    networks:
      - mti-dev-network
    healthcheck:
      test: [ "CMD-SHELL", "wget -qO- http://localhost:8080/actuator/health | grep -q '\"status\":\"UP\"'" ]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 20s

  usersSevice:
    image: mof1us/users-service-mti-dev:latest
    pull_policy: always
    environment:
      EUREKA_SERVER_PORT: 8761
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: UsersMtiDatabaseDev
      DB_USERNAME: postgres
      DB_PASSWORD: ${DB_PASS}
      EUREKA_SERVER_HOST: eureka
      API_GATEWAY: http://gateway:8080
      BACKEND_API_KEY: ${BACKEND_API_KEY}
      MAILCOW_PASSWORD: ${MAILCOW_PASSWORD}
      EMAIL_DOMAIN: ${EMAIL_DOMAIN}
    depends_on:
      eurekaServer:
        condition: service_healthy
      postgresDatabase:
        condition: service_healthy
    networks:
      - mti-dev-network
    healthcheck:
      test: [ "CMD-SHELL", "wget -qO- http://localhost:8080/actuator/health | grep -q '\"status\":\"UP\"'" ]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 20s

  registrationService:
    image: mof1us/registration-service-mti-dev:latest
    pull_policy: always
    environment:
      EUREKA_SERVER_PORT: 8761
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: RegistrationMtiDatabaseDev
      DB_USERNAME: postgres
      DB_PASSWORD: ${DB_PASS}
      EUREKA_SERVER_HOST: eureka
      API_GATEWAY: http://gateway:8080
      BACKEND_API_KEY: ${BACKEND_API_KEY}
    depends_on:
      eurekaServer:
        condition: service_healthy
      postgresDatabase:
        condition: service_healthy
    networks:
      - mti-dev-network
    healthcheck:
      test: [ "CMD-SHELL", "wget -qO- http://localhost:8080/actuator/health | grep -q '\"status\":\"UP\"'" ]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 20s

  tournamentsService:
    image: mof1us/tournaments-mti-service-dev:latest
    pull_policy: always
    environment:
      EUREKA_SERVER_PORT: 8761
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: TournamentsMtiDatabaseDev
      DB_USERNAME: postgres
      DB_PASSWORD: ${DB_PASS}
      EUREKA_SERVER_HOST: eureka
      API_GATEWAY: http://gateway:8080
      BACKEND_API_KEY: ${BACKEND_API_KEY}
    depends_on:
      eurekaServer:
        condition: service_healthy
      postgresDatabase:
        condition: service_healthy
    networks:
      - mti-dev-network
    healthcheck:
      test: [ "CMD-SHELL", "wget -qO- http://localhost:8080/actuator/health | grep -q '\"status\":\"UP\"'" ]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 20s

  umami:
    image: ghcr.io/umami-software/umami:latest
    ports:
      - "5003:3000"
    environment:
      DATABASE_URL: postgresql://umami:umami@db:5432/umami
      APP_SECRET: asdadasfhgjaskjfgasdf
    depends_on:
      db:
        condition: service_healthy
    init: true
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "curl http://localhost:3000/api/heartbeat"]
      interval: 5s
      timeout: 5s
      retries: 5

  db:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: umami
      POSTGRES_USER: umami
      POSTGRES_PASSWORD: umami
    volumes:
      - umami-dev-db-data:/var/lib/postgresql/data
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]
      interval: 5s
      timeout: 5s
      retries: 5

networks:
  mti-dev-network:
    driver: bridge
    ipam:
      config:
        - subnet: 10.250.0.0/24
          gateway: 10.250.0.1
volumes:
  mti-dev-pgdata: { }
  mti-files-server: { }
  umami-dev-db-data: {}